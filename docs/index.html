<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Global Liquidity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              gray: { 850: "#1a202c", 900: "#171923", 950: "#0d1117" },
              lcw: {
                green: "#00d092",
                red: "#ff4949",
                dark: "#14161f",
                panel: "#1e2029",
              },
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #14161f;
        color: #e2e8f0;
        font-family: "Inter", sans-serif;
      }
      .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
      }
      select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        -webkit-print-color-adjust: exact;
      }
    </style>
  </head>
  <body class="min-h-screen flex flex-col">
    <nav class="bg-lcw-panel border-b border-gray-800 p-4 sticky top-0 z-50">
      <div
        class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4"
      >
        <div class="flex items-center gap-3 w-full md:w-auto">
          <i class="ph-fill ph-currency-btc text-orange-500 text-3xl"></i>
          <div>
            <h1 class="text-xl font-bold tracking-tight">
              Liquidity Aggregator
            </h1>
            <div class="text-xs text-gray-400 flex items-center gap-2">
              <span
                id="status-indicator"
                class="w-2 h-2 rounded-full bg-gray-500"
              ></span>
              <span id="status-text">Initializing...</span>
            </div>
          </div>
        </div>

        <!-- Symbol Selector -->
        <div class="flex items-center gap-2">
          <select
            id="symbol-select"
            onchange="changeSymbol(this.value)"
            class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          >
            <option value="BTC-USDT">BTC-USDT</option>
            <option value="ETH-USDT">ETH-USDT</option>
            <option value="SOL-USDT">SOL-USDT</option>
            <option value="XRP-USDT">XRP-USDT</option>
            <option value="BNB-USDT">BNB-USDT</option>
            <option value="DOGE-USDT">DOGE-USDT</option>
          </select>
        </div>

        <div
          class="flex gap-4 text-sm font-medium w-full md:w-auto justify-end"
        >
          <div class="text-right">
            <div class="text-gray-400">Avg Price</div>
            <div class="text-white text-lg" id="global-price">---</div>
          </div>
          <div class="text-right">
            <div class="text-gray-400">Spread</div>
            <div class="text-lcw-green" id="global-spread">---</div>
          </div>
        </div>
      </div>
    </nav>

    <main class="container mx-auto p-4 flex-grow space-y-6">
      <div class="bg-lcw-panel rounded-xl shadow-lg border border-gray-800 p-1">
        <div
          class="p-4 border-b border-gray-800 flex justify-between items-center"
        >
          <h2 class="font-semibold text-lg flex items-center gap-2">
            <i class="ph ph-chart-bar"></i>
            <span id="chart-title">Global Depth</span>
          </h2>
          <div class="text-xs text-gray-500" id="last-updated"></div>
        </div>
        <div class="p-4 chart-container">
          <canvas id="depthChart"></canvas>
        </div>
      </div>

      <div
        class="bg-lcw-panel rounded-xl shadow-lg border border-gray-800 overflow-hidden"
      >
        <div class="p-4 border-b border-gray-800">
          <h2 class="font-semibold text-lg flex items-center gap-2">
            <i class="ph ph-bank"></i> Markets
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead class="bg-gray-800/50 text-gray-400 text-xs uppercase">
              <tr>
                <th class="p-4">Exchange</th>
                <th class="p-4 text-right">Price</th>
                <th class="p-4 text-right">Spread ($)</th>
                <th class="p-4 text-right">Spread (%)</th>
                <th class="p-4 text-right">Liquidity Score</th>
              </tr>
            </thead>
            <tbody
              id="markets-table-body"
              class="text-sm divide-y divide-gray-800"
            >
              <tr>
                <td colspan="5" class="p-8 text-center text-gray-500">
                  Select a symbol to load data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <script>
      let chartInstance = null;

      // 1. Get symbol from URL or default to BTC-USDT
      const urlParams = new URLSearchParams(window.location.search);
      const currentSymbol = urlParams.get("symbol") || "BTC-USDT";

      // Set dropdown to current symbol
      const selector = document.getElementById("symbol-select");
      if (![...selector.options].some((o) => o.value === currentSymbol)) {
        // Add custom option if it's not in the list
        const opt = document.createElement("option");
        opt.value = currentSymbol;
        opt.text = currentSymbol;
        selector.add(opt);
      }
      selector.value = currentSymbol;
      document.getElementById("chart-title").innerText =
        `${currentSymbol} Depth`;

      function changeSymbol(newSymbol) {
        window.location.search = `?symbol=${newSymbol}`;
      }

      async function fetchData() {
        updateStatus(
          "Checking Manifest...",
          "bg-yellow-500",
          "text-yellow-500",
        );

        try {
          // 1. Fetch the Manifest for this specific symbol
          // e.g., manifest_ETH-USDT.json
          const manifestUrl = `manifest_${currentSymbol}.json?t=${Date.now()}`;
          const manifestResp = await fetch(manifestUrl);

          if (!manifestResp.ok) {
            throw new Error(`No data found for ${currentSymbol}`);
          }

          const manifest = await manifestResp.json();

          // 2. Fetch the actual data file indicated by the manifest
          updateStatus("Loading Data...", "bg-blue-500", "text-blue-500");
          const dataResp = await fetch(
            `${manifest.latest_file}?t=${Date.now()}`,
          );

          if (!dataResp.ok) throw new Error("Data file missing");

          const data = await dataResp.json();

          updateStatus(
            "Connected",
            "bg-lcw-green shadow-[0_0_10px_#00d092]",
            "text-lcw-green",
          );

          const date = new Date(data.timestamp);
          document.getElementById("last-updated").innerText =
            `Generated: ${date.toLocaleString()}`;

          processAndRender(data);
        } catch (error) {
          console.error(error);
          updateStatus(`Error: ${error.message}`, "bg-red-500", "text-red-500");
          document.getElementById("markets-table-body").innerHTML =
            `<tr><td colspan="5" class="p-8 text-center text-red-400">Could not load data for ${currentSymbol}.<br>Has the generator run for this coin yet?</td></tr>`;
        }
      }

      function updateStatus(text, dotClass, textClass) {
        document.getElementById("status-indicator").className =
          `w-2 h-2 rounded-full ${dotClass}`;
        const txt = document.getElementById("status-text");
        txt.innerText = text;
        txt.className = `font-medium ${textClass}`;
      }

      function processAndRender(payload) {
        const { bids, asks } = aggregateGlobalBook(payload.results);
        updateChart(bids, asks);
        updateTable(payload.results);
        updateGlobalStats(payload.results);
      }

      function aggregateGlobalBook(results) {
        let allBids = [];
        let allAsks = [];
        results.forEach((ex) => {
          if (ex.data) {
            ex.data.forEach((point) => {
              if (point.bidCum)
                allBids.push({ price: point.price, qty: point.qty });
              if (point.askCum)
                allAsks.push({ price: point.price, qty: point.qty });
            });
          }
        });

        allBids.sort((a, b) => b.price - a.price);
        allAsks.sort((a, b) => a.price - b.price);

        const processedBids = [];
        let bidCum = 0;
        // Limit points for chart performance
        for (let i = 0; i < Math.min(allBids.length, 600); i++) {
          bidCum += allBids[i].qty;
          processedBids.push({ x: allBids[i].price, y: bidCum });
        }

        const processedAsks = [];
        let askCum = 0;
        for (let i = 0; i < Math.min(allAsks.length, 600); i++) {
          askCum += allAsks[i].qty;
          processedAsks.push({ x: allAsks[i].price, y: askCum });
        }
        processedBids.reverse();
        return { bids: processedBids, asks: processedAsks };
      }

      function updateChart(bids, asks) {
        const ctx = document.getElementById("depthChart").getContext("2d");
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            datasets: [
              {
                label: "Bids",
                data: bids,
                borderColor: "#00d092",
                backgroundColor: "rgba(0, 208, 146, 0.2)",
                fill: true,
                pointRadius: 0,
                borderWidth: 2,
              },
              {
                label: "Asks",
                data: asks,
                borderColor: "#ff4949",
                backgroundColor: "rgba(255, 73, 73, 0.2)",
                fill: true,
                pointRadius: 0,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: "index" },
            scales: {
              x: {
                type: "linear",
                grid: { color: "#2d3748" },
                ticks: { color: "#a0aec0" },
              },
              y: { grid: { color: "#2d3748" }, ticks: { color: "#a0aec0" } },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      function updateTable(results) {
        const tbody = document.getElementById("markets-table-body");
        tbody.innerHTML = "";
        const validResults = results
          .filter((r) => !r.error && r.spread)
          .sort((a, b) => a.spread.spread - b.spread.spread);

        if (validResults.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500">No valid market data found.</td></tr>`;
          return;
        }

        validResults.forEach((r) => {
          const spreadPct = (r.spread.spread / r.spread.best_ask) * 100;
          let spreadColor =
            spreadPct < 0.05
              ? "text-lcw-green"
              : spreadPct > 0.5
                ? "text-red-400"
                : "text-gray-300";
          const liquidity = r.data.reduce((sum, item) => sum + item.qty, 0);

          const row = `
                    <tr class="hover:bg-gray-800/50 transition">
                        <td class="p-4 flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full bg-gray-700 flex items-center justify-center text-[10px] text-white">${r.exchange.substring(0, 2).toUpperCase()}</div>
                            <span class="font-medium text-white">${r.exchange}</span>
                        </td>
                        <td class="p-4 text-right font-mono text-white">$${r.spread.best_ask.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                        <td class="p-4 text-right font-mono text-gray-400">$${r.spread.spread.toFixed(2)}</td>
                        <td class="p-4 text-right font-mono ${spreadColor}">${spreadPct.toFixed(3)}%</td>
                        <td class="p-4 text-right font-mono text-gray-500">${liquidity.toFixed(2)}</td>
                    </tr>
                `;
          tbody.insertAdjacentHTML("beforeend", row);
        });
      }

      function updateGlobalStats(results) {
        const valid = results.filter((r) => !r.error && r.spread);
        if (valid.length === 0) {
          document.getElementById("global-price").innerText = "---";
          document.getElementById("global-spread").innerText = "---";
          return;
        }
        const avgPrice =
          valid.reduce((acc, curr) => acc + curr.spread.mid, 0) / valid.length;
        document.getElementById("global-price").innerText =
          "$" +
          avgPrice.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

        const highestBid = Math.max(...valid.map((r) => r.spread.best_bid));
        const lowestAsk = Math.min(...valid.map((r) => r.spread.best_ask));
        const globalSpread = lowestAsk - highestBid;

        const spreadEl = document.getElementById("global-spread");
        spreadEl.innerText = "$" + globalSpread.toFixed(2);
        spreadEl.className =
          globalSpread < 0 ? "text-orange-400" : "text-lcw-green";
      }

      fetchData();
    </script>
  </body>
</html>
